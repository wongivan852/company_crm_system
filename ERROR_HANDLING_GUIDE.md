# ðŸš¨ Error Handling & Logging Guide\n\n## Enhanced Error Handling Implementation\n\nThe CRM application now includes comprehensive error handling and logging across all components.\n\n## Logging Structure\n\n### Log Files\n- **`logs/crm.log`**: General application logs (INFO level and above)\n- **`logs/crm_errors.log`**: Error-level logs only\n- **`logs/security.log`**: Security-related events (JSON format)\n\n### Log Rotation\n- Maximum file size: 10MB\n- Backup count: 5 files (general), 10 files (security)\n- Automatic rotation when size limit reached\n\n### Logger Categories\n\n#### `crm`\nGeneral application logger\n```python\nimport logging\nlogger = logging.getLogger('crm')\nlogger.info('Customer created successfully')\n```\n\n#### `crm.security`\nSecurity events logger\n```python\nimport logging\nsecurity_logger = logging.getLogger('crm.security')\nsecurity_logger.warning('Suspicious activity detected')\n```\n\n#### `crm.communication`\nCommunication services logger\n```python\nimport logging\ncomm_logger = logging.getLogger('crm.communication')\ncomm_logger.info('WhatsApp message sent')\n```\n\n## Middleware Components\n\n### 1. ErrorHandlingMiddleware\nCentralized exception handling with appropriate responses:\n- **PermissionDenied**: Returns 403 with security logging\n- **ValidationError**: Returns 400 with validation details\n- **Unexpected errors**: Returns 500 with request tracking\n\n### 2. SecurityMiddleware\nSecurity monitoring and threat detection:\n- Suspicious path access detection\n- Missing User-Agent monitoring\n- Request tracking with unique IDs\n\n### 3. RequestLoggingMiddleware\nRequest/response monitoring:\n- API request/response logging\n- Slow request detection (>5 seconds)\n- Performance monitoring\n\n## Communication Services Error Handling\n\n### WhatsApp Service\nâœ… **Input validation**: Phone number format, message length\nâœ… **API configuration validation**: Token, URL, phone number ID\nâœ… **Timeout handling**: 30-second request timeout\nâœ… **Connection error handling**: Network issues\nâœ… **Rate limiting awareness**: API quota management\nâœ… **Detailed logging**: Success/failure with metrics\n\n### Email Service\nâœ… **Input validation**: Email format, required fields\nâœ… **Connection handling**: SMTP connection management\nâœ… **Delivery confirmation**: Result validation\nâœ… **HTML/text support**: Alternative content types\nâœ… **Error categorization**: SMTP vs application errors\n\n### Communication Manager\nâœ… **Channel validation**: Supported communication channels\nâœ… **Contact availability**: Customer contact information checks\nâœ… **Fallback handling**: Alternative communication methods\nâœ… **Comprehensive logging**: Full communication audit trail\n\n## API Error Handling\n\n### Custom DRF Exception Handler\nEnhanced API error responses:\n```json\n{\n  \"error\": true,\n  \"message\": \"An error occurred\",\n  \"code\": \"VALIDATION_ERROR\",\n  \"details\": {\n    \"field_name\": [\"This field is required\"]\n  },\n  \"timestamp\": 1640995200.123,\n  \"request_id\": \"1640995200-12345\"\n}\n```\n\n### Error Codes\n- `PERMISSION_DENIED`: Access denied\n- `VALIDATION_ERROR`: Input validation failed\n- `AUTHENTICATION_FAILED`: Invalid credentials\n- `THROTTLED`: Rate limit exceeded\n- `INTERNAL_ERROR`: Unexpected server error\n\n## Monitoring & Health Checks\n\n### Health Check Endpoint\n**URL**: `/health/`\n\n**Response**:\n```json\n{\n  \"timestamp\": \"2024-01-01T12:00:00Z\",\n  \"overall_status\": \"healthy\",\n  \"checks\": {\n    \"database\": {\n      \"status\": \"healthy\",\n      \"message\": \"Database connection OK\",\n      \"details\": {\n        \"customer_count\": 150,\n        \"db_vendor\": \"postgresql\"\n      },\n      \"duration_ms\": 45.2\n    },\n    \"memory\": {\n      \"status\": \"healthy\",\n      \"message\": \"Memory OK: 65.3% used\",\n      \"details\": {\n        \"used_percent\": 65.3,\n        \"available_gb\": 2.1,\n        \"total_gb\": 6.0\n      },\n      \"duration_ms\": 12.1\n    }\n  }\n}\n```\n\n### Metrics Endpoint\n**URL**: `/metrics/`\n\n**Response**:\n```json\n{\n  \"customers\": {\n    \"total\": 150,\n    \"active\": 120,\n    \"prospects\": 25,\n    \"recent_24h\": 5\n  },\n  \"communications\": {\n    \"total_24h\": 45,\n    \"email_24h\": 30,\n    \"whatsapp_24h\": 15\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n```\n\n## Security Event Logging\n\n### Suspicious Activity Detection\n- Admin panel access attempts\n- Common attack path scanning\n- Configuration file access attempts\n- Backup file access attempts\n\n### Security Log Format (JSON)\n```json\n{\n  \"level\": \"WARNING\",\n  \"time\": \"2024-01-01 12:00:00,123\",\n  \"module\": \"middleware\",\n  \"message\": \"Suspicious path access: /admin\",\n  \"security_event\": \"suspicious_path\",\n  \"client_ip\": \"192.168.1.100\",\n  \"path\": \"/admin\",\n  \"user_agent\": \"Mozilla/5.0...\",\n  \"request_id\": \"1640995200-12345\"\n}\n```\n\n## Error Response Examples\n\n### Validation Error\n```json\n{\n  \"error\": true,\n  \"message\": \"Validation failed\",\n  \"code\": \"VALIDATION_ERROR\",\n  \"details\": {\n    \"email_primary\": [\"Enter a valid email address.\"]\n  },\n  \"timestamp\": 1640995200.123\n}\n```\n\n### Authentication Error\n```json\n{\n  \"error\": true,\n  \"message\": \"Authentication failed\",\n  \"code\": \"AUTHENTICATION_FAILED\",\n  \"details\": \"Invalid token.\",\n  \"timestamp\": 1640995200.123\n}\n```\n\n### Internal Server Error\n```json\n{\n  \"error\": true,\n  \"message\": \"Internal server error\",\n  \"code\": \"INTERNAL_ERROR\",\n  \"request_id\": \"1640995200-12345\",\n  \"timestamp\": 1640995200.123\n}\n```\n\n## Best Practices\n\n### For Developers\n1. **Use appropriate log levels**:\n   - `DEBUG`: Detailed diagnostic info\n   - `INFO`: General information\n   - `WARNING`: Something unexpected happened\n   - `ERROR`: Serious problem occurred\n   - `CRITICAL`: Very serious error\n\n2. **Include context in logs**:\n   ```python\n   logger.info(\n       \"Customer created\",\n       extra={\n           'customer_id': customer.id,\n           'user_id': request.user.id,\n           'action': 'create_customer'\n       }\n   )\n   ```\n\n3. **Handle exceptions gracefully**:\n   ```python\n   try:\n       result = risky_operation()\n   except SpecificException as e:\n       logger.error(f\"Specific error: {e}\", exc_info=True)\n       return error_response\n   except Exception as e:\n       logger.error(f\"Unexpected error: {e}\", exc_info=True)\n       return generic_error_response\n   ```\n\n### For Operations\n1. **Monitor log files regularly**\n2. **Set up alerts for ERROR level logs**\n3. **Review security logs daily**\n4. **Monitor health check endpoint**\n5. **Track metrics trends**\n\n## Troubleshooting\n\n### Common Issues\n\n**Log files not created**\n- Check `logs/` directory exists\n- Verify write permissions\n- Check disk space\n\n**Health check failing**\n- Check database connectivity\n- Verify external API configurations\n- Monitor system resources\n\n**High error rates**\n- Review error logs for patterns\n- Check external service status\n- Monitor system performance\n\n### Debug Mode vs Production\n\n**Development (DEBUG=True)**:\n- Detailed error pages\n- Console logging enabled\n- Less restrictive error handling\n\n**Production (DEBUG=False)**:\n- Generic error responses\n- File logging only\n- Enhanced security logging\n- Comprehensive error tracking\n\n## Integration with External Tools\n\n### Log Aggregation\nRecommended tools:\n- **ELK Stack** (Elasticsearch, Logstash, Kibana)\n- **Fluentd** for log forwarding\n- **Grafana** for metrics visualization\n\n### Alerting\nRecommended tools:\n- **Prometheus** + **Alertmanager**\n- **Sentry** for error tracking\n- **New Relic** for APM\n\n### Example Alerting Rules\n```yaml\n# Prometheus alert rules\ngroups:\n- name: crm_alerts\n  rules:\n  - alert: HighErrorRate\n    expr: rate(django_http_responses_total{status=~\"5..\"}[5m]) > 0.1\n    for: 2m\n    annotations:\n      summary: \"High error rate detected\"\n  \n  - alert: DatabaseDown\n    expr: up{job=\"crm-health-check\"} == 0\n    for: 1m\n    annotations:\n      summary: \"CRM health check failing\"\n```\n\nThis comprehensive error handling system provides robust monitoring, detailed logging, and graceful error recovery for the CRM application.